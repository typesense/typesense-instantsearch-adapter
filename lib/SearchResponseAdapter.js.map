{"version":3,"sources":["../src/SearchResponseAdapter.js"],"names":["SearchResponseAdapter","typesenseResponse","instantsearchRequest","typesenseGroupedHits","adaptedResult","map","groupedHit","_adaptHits","hits","flat","typesenseHits","typesenseHit","adaptedHit","document","objectID","id","_snippetResult","_adaptHighlightResult","_highlightResult","snippetOrValue","result","Object","assign","entries","attribute","value","matchLevel","matchedWords","highlights","forEach","highlight","field","k","v","Array","isArray","push","_adaptHighlightTag","params","highlightPreTag","highlightPostTag","typesenseFacetCounts","facet","field_name","counts","count","keys","stats","length","grouped_hits","_adaptGroupedHits","nbHits","found","page","nbPages","_adaptNumberOfPages","hitsPerPage","request_params","per_page","facets","_adaptFacets","facet_counts","facets_stats","_adaptFacetStats","query","q","processingTimeMS","search_time_ms","prototype","utils"],"mappings":"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","sourcesContent":["\"use strict\";\n\nimport { utils } from \"./support/utils\";\n\nexport class SearchResponseAdapter {\n  constructor(typesenseResponse, instantsearchRequest) {\n    this.typesenseResponse = typesenseResponse;\n    this.instantsearchRequest = instantsearchRequest;\n  }\n\n  _adaptGroupedHits(typesenseGroupedHits) {\n    let adaptedResult = [];\n\n    adaptedResult = typesenseGroupedHits.map(groupedHit =>\n      this._adaptHits(groupedHit.hits)\n    );\n\n    // adaptedResult is now in the form of [[{}, {}], [{}, {}], ...]\n    //  where each element in the outer most array corresponds to a group.\n    // We now flatten it to [{}, {}, {}]\n    adaptedResult = adaptedResult.flat();\n\n    return adaptedResult;\n  }\n\n  _adaptHits(typesenseHits) {\n    let adaptedResult = [];\n    adaptedResult = typesenseHits.map(typesenseHit => {\n      const adaptedHit = {\n        ...typesenseHit.document\n      };\n      adaptedHit.objectID = typesenseHit.document.id;\n      adaptedHit._snippetResult = this._adaptHighlightResult(\n        typesenseHit,\n        \"snippet\"\n      );\n      adaptedHit._highlightResult = this._adaptHighlightResult(\n        typesenseHit,\n        \"value\"\n      );\n      return adaptedHit;\n    });\n    return adaptedResult;\n  }\n\n  _adaptHighlightResult(typesenseHit, snippetOrValue) {\n    // Algolia lists all searchable attributes in this key, even if there are no matches\n    // So do the same and then override highlights\n\n    const result = Object.assign(\n      {},\n      ...Object.entries(typesenseHit.document).map(([attribute, value]) => ({\n        [attribute]: {\n          value: value,\n          matchLevel: \"none\",\n          matchedWords: []\n        }\n      }))\n    );\n\n    typesenseHit.highlights.forEach(highlight => {\n      result[highlight.field] = {\n        value: highlight[snippetOrValue] || highlight[`${snippetOrValue}s`],\n        matchLevel: \"full\",\n        matchedWords: [] // Todo: Fix MatchedWords\n      };\n    });\n\n    // Now convert any values that have an array value\n    // Also, replace highlight tag\n    Object.entries(result).forEach(([k, v]) => {\n      const attribute = k;\n      const { value, matchLevel, matchedWords } = v;\n      if (Array.isArray(value)) {\n        result[attribute] = [];\n        value.forEach(v => {\n          result[attribute].push({\n            value: this._adaptHighlightTag(\n              `${v}`,\n              this.instantsearchRequest.params.highlightPreTag,\n              this.instantsearchRequest.params.highlightPostTag\n            ),\n            matchLevel: matchLevel, // TODO: Fix MatchLevel for array\n            matchedWords: matchedWords // TODO: Fix MatchedWords for array\n          });\n        });\n      } else {\n        // Convert all values to strings\n        result[attribute].value = this._adaptHighlightTag(\n          `${value}`,\n          this.instantsearchRequest.params.highlightPreTag,\n          this.instantsearchRequest.params.highlightPostTag\n        );\n      }\n    });\n    return result;\n  }\n\n  _adaptFacets(typesenseFacetCounts) {\n    const adaptedResult = {};\n    typesenseFacetCounts.forEach(facet => {\n      Object.assign(adaptedResult, {\n        [facet.field_name]: Object.assign(\n          {},\n          ...facet.counts.map(count => ({ [count.value]: count.count }))\n        )\n      });\n    });\n    return adaptedResult;\n  }\n\n  _adaptFacetStats(typesenseFacetCounts) {\n    const adaptedResult = {};\n    typesenseFacetCounts.forEach(facet => {\n      if (Object.keys(facet.stats).length > 0) {\n        Object.assign(adaptedResult, {\n          [facet.field_name]: facet.stats\n        });\n      }\n    });\n    return adaptedResult;\n  }\n\n  adapt() {\n    const adaptedResult = {\n      hits: this.typesenseResponse.grouped_hits\n        ? this._adaptGroupedHits(this.typesenseResponse.grouped_hits)\n        : this._adaptHits(this.typesenseResponse.hits),\n      nbHits: this.typesenseResponse.found,\n      page: this.typesenseResponse.page - 1,\n      nbPages: this._adaptNumberOfPages(),\n      hitsPerPage: this.typesenseResponse.request_params.per_page,\n      facets: this._adaptFacets(this.typesenseResponse.facet_counts || []),\n      facets_stats: this._adaptFacetStats(\n        this.typesenseResponse.facet_counts || {}\n      ),\n      query: this.typesenseResponse.request_params.q,\n      processingTimeMS: this.typesenseResponse.search_time_ms\n    };\n\n    // console.log(adaptedResult);\n    return adaptedResult;\n  }\n}\n\nObject.assign(SearchResponseAdapter.prototype, utils);\n"],"file":"SearchResponseAdapter.js"}